---
title: "MBI_MA_v7_PS"
author: "Sicong Liu"
date: "2/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE, dpi = 300, cache.lazy = FALSE, tidy = "styler", out.width = "90%", fig.align = "center", fig.width = 10, fig.asp = 0.618, error = F, warning = F)
options(dplyr.print_min=Inf,
        tibble.width=Inf, 
        tibble.print_max=20,
        max.print = 100000,
        digits = 5, 
        scipen=999999)

rm(list=ls())
library(metafor)
library(robumeta)
library(clubSandwich)                       # for RVE with metafor; requires version 0.5.1 or higher
library(tidyverse)
library(weightr)
library(ggplot2)
library(grid)
library(gridExtra)
library(gghalves)
library(ggridges)
library(ggExtra)
library(GGally)        # plot data of continuous and categorical variables in matrix form
library(hrbrthemes)    # fonts & background (e.g., dark mode)
library(patchwork)     # multiple plots
library(viridis)
library(reshape2)
library(cowplot)
library(dplyr)
library(janitor)
library(lavaan)
library(VIM)
set.seed(55555)

# win <- "C:/Users/sliu/Box/"
# mac <- "~/Box Sync/"
# mac2 <- "~/Box Sync/Zone/7_MBI_Database/PS_Model/"
# win_desktop <- "C:/Users/sliu/OneDrive - PennO365/Desktop/"
# mac_desktop <- "~/Desktop/"

# reduce name list length
rm_var <- c(
            
            "hiv_recnum", "drug_recnum", # "changeout", "changesd", "changeaux",                                               #--- new var added in 'fall22check' round
            "varname", "outcomeID", "prob_mean", "wave_base1", "behcli", "g", "INC", "PRPOS", "GR1", "GR2", "GR3", # "type", 
            # "w1", "w2", "w3", "w4", "w5", "w6","w7", "w8", "flag_change", 
            "m", "c", "multiple", "d", "dv", "wt", "grpname", "inflbhvr",
            "T1", "T2", "T3", "T4", "T5", "recommend", "AUXrecomend", 
            "epeep", "baseline", "intervention",
            "st2", "st3", "st4", "st5",
            "OTPRGDR", "OTPRTOB", "OTPRAU", "OTPREX", "OTPRDIE", "OTPRCU", "OTPRSA", "OTPRHBC", "OTPRGOT",  "OTPRGOT2", "BKGRADT", "ADTSIMUL", "DEMOSPC", 
            
            
            # is drug use/tobacco use/alcohol use/exercise/diet/condom use/sexual abstinence/hormonal birth control/1st other/2nd other
            "OTPRGDR", "OTPRTOB", "OTPRAU", "OTPREX", "OTPRDIE", "OTPRCU", "OTPRSA", "OTPRHBC", "OTPRGOT",  "OTPRGOT2",                     #  ? many missing values ? 
            # additional treatment in the background, happening simultaneously, demographic information available group-wise
            "BKGRADT", "ADTSIMUL", "DEMOSPC", 
            
            "TARGETED", "WHOTARGT", "whotargtcmbo", "whotargtot", "RACETARG", "GENDTARG", "CULTURE", "SAMEDIFF", 
            
            
            "DURATJ3NOCV", "DURATJ3MIN", "DURATJ3DAY", "payj3", "GRPINDJ3T", "SELFSEL", "RECRUIT", "recruitoth", "recruitmul", "CTXT", "ctxtoyh", "ctxtmul", "DELVR", "delvroth", "AVISITS", 
            
            
            
            # Demo Table 2
            # The following groups of variables are describing beginning, end, and total of the intervention
            "rcptmsi", "rcptmfi", "rcptmyoy",                           # % group participants are male
            "RCPTFsi", "RCPTFfi", "RCPTFtot",                           # % group participants are female 
            "RCPTNsi", "RCPTNfi", "RCPTNtot",                           # % group participants whose gender was not indicated
            "RCPTHsi", "RCPTHfi", "RCPTHtot",                           # % group participants who are straight
            "RCPTGsi", "RCPTGfi", "RCPTGtot",                           # % group participants who are gay or bisexual
            "RCPTOsi", "RCPTOfi", "RCPTOtot",                           # % group participants who are heterosexual ???? difference compared to 'straight?'
            "RCPTMUsi", "RCPTMUfi", "RCPTMUtot",                        # % group participants who have multiple partners
            "RCPTSsi", "RCPTSfi", "RCPTStot",                           # % group participants who are not sexually active
            "LOAGRsi", "LOAGRfi", "LOAGRtot",                           # lowest age of participants
            "HIAGRsi", "HIAGRfi", "HIAGRtot",                           # highest age of participants 
            "AGMNsi", "AGMNfi", "AGMNtot",                              # mean age of participants
            "RACERsi", "RACERfi", "RACERtot",                           # perceived race of group participants
            "racersioth", "racersimul",                                 # indicate other races; multiple races
            "WHITEsi", "WHITEfi", "WHITEtot",                           # % group participants who are European descent
            "NATIVsi", "NATIVfi", "NATIVtot",                           # % group participants who are Native-American descent
            "BLACKsi", "BLACKfi", "BLACKtot",                           # % group participants who are African descent
            "ASIANsi", "ASIANfi", "ASIANtot",                           # % group participants who are Asian descent
            "HISPsi", "HISPfi", "HISPtot",                              # % group participants who are Latin descent
            "OTHERsi", "OTHERfi", "OTHERtot",                           # % group participants who are Other Race descent
            "NIsi", "NIfi", "NItot",                                    # % group participants whose descent was not indicated
            "HIGHSCHOOLsi", "HIGHSCHOOLfi", "HIGHSCHOOLtot",            # % group participants who completed high school
            "EDUCsi", "EDUCfi", "EDUCtot",                              # mean years of education
            "INCOMEsi", "INCOMEfi", "INCOMEtot",                        # median annual income
            "PREDISsi", "PREDISfi", "PREDIStot",                        # % group participants w/ a disease
            "predis",                                                   # specify the disease
            
  # Comm Table 1
  # The following groups of variables are generally asking "Does the intervention communication XXX"
  "scaa",                          # use attitudinal argument
  "scna",                          # use normative argument 
  "scca",                           # use control argument
  "scta",                                  # use threat argument
  "scai",                          # use information argument
  "scsc",                          # use social comparison argument
  "scsoch",                          # use social change argument
  "scgt",                          # use graded tasks 
  "scsoc",                          # use stage of change approach
  "scaddict",                          # Is the intervention an addiction treatment
  "scas",                           # teach skills
  "scinsh",                          # provide instructions 
  "scrp",                          # use role playing
  "scsgrpg",                          # use set specific goals or review past goals
  "sccu",                          # teach cues related to a behavior
  "screh",                                 # prompt rehearse or repeat the behaviors
  "scbar",                                  # show what to do when faced with barriers
  "sccs",                          # teach comm. skills
  "screl",                          # identify and try to anticipate/counter relapse factors
  "scretech",                          # teach relaxation techniques
  "sctime",                          # show how to make time to perform the behaviors
  "scsm",                          # use self-monitoring prompts
  "scbc",                          # use behavioral contracts
  "scbm",                          # include biological methods
  "scmss",                          # teach skills to manage stress
  "scos",                          # teach other skills
  "scos2",                          # specify other skills                  !!!! open 
  "scfb",                                  # provide feedback
  "sccr",                          # provide contingent rewards
  "scge",                          # use general encouragement
  "scmi",                          # use motivational interviewing
  "scrm",                          # prompt identification as a role model
  "sccon",                          # contact participants again after the main intervention
  "scome",                          # are there other motivational elements
  "scome2",                          # specify other motivational elements    !!!! open 
  "describe",                          # did the report provide a detailed description of the intervention
  "other",                          # Other elements not identified       !!!! open 
  
  
  # Comm Source Table 2
  "csn",                          # number of communication sources
  "csnom",                          # number of male communication sources
  "csnof",                                 # number of female communication sources
  "cssf",                          # are the source female
  "cssm",                          # are the source male
  "cslas",                          # lowest age of the communication sources
  "clhas",                          # highest age of the communication sources
  "csprs",                          # perceived race of the communication source
  "cses",                          # number of European/American sources
  "csns",                          # number of Native American sources
  "csafs",                          # number of African sources
  "csass",                          # number of Asian sources
  "cshs",                          # number of Hispanic sources
  "cspeer",                          # is the source a peer
  "csagpeer",                              # is the source an age group peer
  "csrpeer",                          # is the source a racial peer
  "csgpeer",                          # is the source a gender peer
  "cssopeer",                          # is the source a sexual orientation peer
  "csrgpeer",                          # is the source a risk group peer
  "scsi",                          # source identity in the intervention
  "scsimul",                          # if multiple sources, specify     !!! open
  "scsioth",                          # other identity sources
  "scother",                          # other communication sources 
  "diffcs",                          # are different communication elements reported for different outcomes?
  "intotreat",                     # the study uses intention-to-treat analysis
  "scsioth1",                      # other identity sources             !!! open
            
            
            "numberofrows", "d_distress", "d_motiv", "d_info", "d_skill", "elaborative_d", "info_wellbeing")

# df <- read_csv(paste0(win, "Zone/7_MBI_Database/MBX Stuff to Share/dat2.csv"))           # 1st submission
df <- read_csv(paste0("../data/mid/4_psScore/dat2_rev1.csv"))                            # 1st revision

dat <- df %>% 
  dplyr::select(-rm_var) 

# aux <- read.csv(paste0(mac, "Zone/7_MBI_Database/MBX Stuff to Share/CompleteES+Aux_May2021.csv"))

# names(df); 
# tabyl(df$csrpeer)
# tabyl(df$OTPRGDR); tabyl(df$OTPRTOB); tabyl(df$OTPRAU); tabyl(df$OTPREX); tabyl(df$OTPRDIE); tabyl(df$OTPRCU)
# df %>% distinct(ID, .keep_all = T) %>% tabyl(studyid) %>% tabyl(n)
```

### Predictor Candidates    
Below I am showing > 100 variables that were initially considered for the propensity score model. Except for the outcome and index variables, all are possible candidates to predict the treatment (i.e., NMainrecom). The principal criteria of considering variables here is that they are supposed to represent information happening before treatment began in the included trials. No variables that are supposed to be affected by the treatment shall be considered for propensity score models. I therefore show all the variables (totaling 294, in the R code) I have checked one by one on such a criteria. Please let me know if you see any inappropriate decisions.    

The specific meanings of a given variable  can be found in the codebook, which mapped all the variables to their meaning and coding values in the online MBI Database. All these variables will be further selected in the upcoming steps.
```{r select_var, echo=T}
ps_var1 <- c(
  # outcome var in PS model ------------
            "NMainrecom",
  
  # index var in PS model ------------
            "reference", 
            "authyear",
            "studyid", 
            "ID", 
            
  # potential predictors ---------------
            # "N",                                        # sample pair number used to calcualte gain-score cohen's d effect size
            "nopostt",                                    # number of post tests 
  
            # "epeep",                                     # participant number eligible for the group
            "baseline",                                  # participant number completed baseline
            # "intervention",                              # participant number completed intervention 
            # "record",                                                  # group identification
            "dofinter",                                                # duration of intervention                      
            "nopostt",                                                 # number of post tests? (Write down #)          
            "NAUXrecomend",                                            # number of aux. recommendation                 
            # "st1",                                                     # sample size at baseline (very similar to "baseline", correlating at .99)
  
            # is drug use/tobacco use/alcohol use/exercise/diet/condom use/sexual abstinence/hormonal birth control/1st other/2nd other  (0/1 variables)
            "OTPRGDR", "OTPRTOB", "OTPRAU", "OTPREX", "OTPRDIE", "OTPRCU", "OTPRSA", "OTPRHBC", # "OTPRGOT",  "OTPRGOT2",                     # comment out open-ended var's 
            # additional treatment in the background, happening simultaneously, demographic information available group-wise
            "BKGRADT", "ADTSIMUL", "DEMOSPC",                                                              # 0/1 variables
            # is the intervention targeted to anyone; who is the target; 
            "TARGETED", "WHOTARGT", # "whotargtcmbo", "whotargtot",       # comment out open-ended var's
            # if combination; race targeted; gender targeted; culture-appropriate intervention; participants are the same at post tests
            "RACETARG", "GENDTARG", "CULTURE", "SAMEDIFF",                                                 # 0/1 variables
            # total duration in hours/mins/days; amount of payment; exposure in a group vs. individual format; self-selected sample;
            "DURATJ3NOCV", "DURATJ3MIN", "DURATJ3DAY", "payj3", "GRPINDJ3T", "SELFSEL", 
            #  participant recruitment location; other locations; multiple means of recruiting; 
            "RECRUIT", # "recruitoth", "recruitmul",                                                       # !!! as.factor
            # dominant communication context; other comm. context; multiple comm. context; 
            "CTXT", # "ctxtoyh", "ctxtmul",                                                                # !!! as.factor
            # intervention delivery context; other delivery context;
            "DELVR", # "delvroth",                                                                         # !!! as.factor
            #  average visit number
            "AVISITS",
            
  
            # Demo Table 2                                                                                 # may need to transform some variables in this section
            # The following groups of variables are describing beginning of the intervention
            "rcptmsi",                          # % group participants are male
            "RCPTFsi",                          # % group participants are female 
            "RCPTNsi",                          # % group participants whose gender was not indicated
            "RCPTHsi",                          # % group participants who are straight
            "RCPTGsi",                          # % group participants who are gay or bisexual
            "RCPTOsi",                          # % group participants who are heterosexual ???? difference compared to 'straight?'
            "RCPTMUsi",                         # % group participants who have multiple partners
            "RCPTSsi",                          # % group participants who are not sexually active
            "LOAGRsi",                          # lowest age of participants
            "HIAGRsi",                          # highest age of participants 
            "AGMNsi",                           # mean age of participants
            "RACERsi",                          # perceived race of group participants                      # !!! as.factor
            # "racersioth", "racersimul",         # indicate other races; multiple races
            "WHITEsi",                          # % group participants who are European descent
            "NATIVsi",                          # % group participants who are Native-American descent
            "BLACKsi",                          # % group participants who are African descent
            "ASIANsi",                          # % group participants who are Asian descent
            "HISPsi",                           # % group participants who are Latin descent
            "OTHERsi",                          # % group participants who are Other Race descent
            "NIsi",                             # % group participants whose descent was not indicated
            "HIGHSCHOOLsi",                     # % group participants who completed high school
            "EDUCsi",                           # mean years of education
            "INCOMEsi",                         # median annual income
            "PREDISsi",                         # % group participants w/ a disease
  
  
  # Comm Table 1
  # The following groups of variables are generally asking "Does the intervention communication XXX"
  "scaa",                          # use attitudinal argument
  "scna",                          # use normative argument 
  "scca",                           # use control argument
  "scta",                                  # use threat argument
  "scai",                          # use information argument
  "scsc",                          # use social comparison argument
  "scsoch",                          # use social change argument
  "scgt",                          # use graded tasks 
  "scsoc",                          # use stage of change approach
  "scaddict",                          # Is the intervention an addiction treatment
  "scas",                           # teach skills
  "scinsh",                          # provide instructions 
  "scrp",                          # use role playing
  "scsgrpg",                          # use set specific goals or review past goals
  "sccu",                          # teach cues related to a behavior
  "screh",                                 # prompt rehearse or repeat the behaviors
  "scbar",                                  # show what to do when faced with barriers
  "sccs",                          # teach comm. skills
  "screl",                          # identify and try to anticipate/counter relapse factors
  "scretech",                          # teach relaxation techniques
  "sctime",                          # show how to make time to perform the behaviors
  "scsm",                          # use self-monitoring prompts
  "scbc",                          # use behavioral contracts
  "scbm",                          # include biological methods
  "scmss",                          # teach skills to manage stress
  "scos",                          # teach other skills
  # "scos2",                          # specify other skills                  !!!! open 
  "scfb",                                  # provide feedback
  "sccr",                          # provide contingent rewards
  "scge",                          # use general encouragement
  "scmi",                          # use motivational interviewing
  "scrm",                          # prompt identification as a role model
  "sccon",                          # contact participants again after the main intervention
  "scome",                          # are there other motivational elements
  # "scome2",                          # specify other motivational elements    !!!! open 
  "describe",                          # did the report provide a detailed description of the intervention
  # "other",                          # Other elements not identified       !!!! open 
  
  # Comm Table 2
  "csn",                          # number of communication sources
  "csnom",                          # number of male communication sources
  "csnof",                          # number of female communication sources
  "cssf",                          # are the source female
  "cssm",                          # are the source male
  "cslas",                          # lowest age of the communication sources
  "clhas",                          # highest age of the communication sources
  "csprs",                          # perceived race of the communication source
  "cses",                          # number of European/American sources
  "csns",                          # number of Native American sources
  "csafs",                          # number of African sources
  "csass",                          # number of Asian sources
  "cshs",                          # number of Hispanic sources
  "cspeer",                          # is the source a peer
  "csagpeer",                       # is the source an age group peer
  "csrpeer",                          # is the source a racial peer                               # !!! as.factor
  "csgpeer",                          # is the source a gender peer                               # !!! as.factor
  "cssopeer",                          # is the source a sexual orientation peer                  # !!! as.factor
  "csrgpeer",                          # is the source a risk group peer                          # !!! as.factor
  "scsi",                          # source identity in the intervention                          # !!! as.factor
  # "scsimul",                          # if multiple sources, specify     !!! open
  "scsioth",                          # other identity sources                                    # 0/1 var
  # "scother",                          # other communication sources     !!! open
  "diffcs",                          # are different communication elements reported for different outcomes?
  "intotreat",                     # the study uses intention-to-treat analysis
  # "scsioth1",                      # other identity sources             !!! open
  
  
# Header form
# "coder",                      # coder of the study                                                # !!! as.factor
# "date",                       # coding date       
"pubyear",                            # year of publication
# "authyear.1",                         # short citation (author, year)
# "newnumb",                            # paper number (skip)
"studyyearbeg",                       # beginning year of the study
"studyyearend",                       # ending year of the study
# "reference",                       # full citation of study
"intyn",                      # the manuscript describes an intervention (Yes/No)                 0/1
"TWGR",                      # at least two groups
"RPRTBHVR",                           # study reports any behavioral outcomes
"FLUP",                               # study include at least one follow-up before 6 month and other after 6 month
"FCLBHVR",                           # focal intervention in the study targets more than one outcome
"DTCONT",                             # study reports data on the control/usual care/one-behavior control group
# "EFSZ",                               # coder can calculate Cohen's d based on statistics if M/SD and proportions are not reported in the study
# "exclus",                             # additional comments on the reason for exclusion        !!! open
# "institj",                            # 1st author's institution
# "institjoth",                         # other institutions if exist        !!! open
"rprt",                               # the entire or subset of the trial is reported          0/1
# "rprtspec",                           # specify if the study reports subset of trial     !!! open
"areaj",                              # 1st author's institutional area (e.g., psych)              # !!! as.factor
# "areajoth",                           # specify if choosing 'other' in previous Q       !!! open
"srctyp",                             # sources of report (e.g., journal)
# "srctypoth",                         # specify if choosing 'other' in previous Q       !!! open
"langj",                              # language of report                          !!! open
"countryj",                           # country of origin of the report                !!! open
# "cities",                             # city/cities location of the study               !!! open
# "states",                             # state/states location of the study              !!! open
# "country",                            # country location of the study              !!! open
# "context",                           # describe the study in a few sentences            !!! open
"designj",                            # research design of the study (e.g., experimental)
# "designjcmbo",                        # specify if combination of the design features exist         !!! open
# "designjoth",                         # specify if combination of 'other' designs        !!! open
"SUBJGRP",                            # independent groups based on subject characteristics
# "GPBASIS",                           # if Yes previous Q, what is the basis of the group (e.g., race, sex...)     # !!! as.factor
# "gpbasisoth",                         # specify if choose 'other' in previous Q          !!! open
# "domains",                            # study domains         !!! open
"Ndomains",                           # how many domains does the study involve (number answer)
# "context1",                           # describe the study in a few sentences (repeating a quesiton above)    !!! redundant
# "INC.y",                              # should include the study if there are any effect sizes                !!! redundant
# "SUBS",                               # subsample             !!! open
"GR1",                              # the study can be included in group 1 (lifestyle)
"GR2",                              # the study can be included in group 2 (HIV)
"GR3"                              # the study can be included in group 3 (alcohol/drug)
# "PRPOS.y"                            # pre and post measures are available
 
# Dynamic Variables
# "target"                      # Was this outcome a target associated with one of the primary recommendations (0 = No, 1 = Yes)   !!! different than 'TARGETED'
            )
```

### Select Variables Based on Missing Value Proportion          
In this step, I modified the data to the level of trial arms (669->866 trial arms) and calculated the missing value proportion for all variables so that only variables with < 0.05 will be further considered because those missing values will be imputed to get a complete dataset.
```{r select_var2, echo=F}
# data for 2nd round based on missing value %
df2 <- df %>%
  dplyr::select(ps_var1) %>% 
  # rename(GR1 = GR1.y, GR2 = GR2.y, GR3 = GR3.y) %>%
  distinct(ID, .keep_all = T)

missing_perc <- 0.07                                                              # 0.05 in 1st submission
qualify_var2 <- sapply(df2, function(i){sum(is.na(i))/length(i) < missing_perc})     
ps_var2 <- names(df2)[qualify_var2]                                               # recptmsi (0.1163842) -> RCPTFsi (0.1016949)

# show missing proportions
sapply(df2, function(i){sum(is.na(i))/length(i)})
sort(ps_var2)
```

Here is the list of 43 included variables with missing value proportions < 0.05.  
```{r select_var3, echo=F}
# data for 3rd round based on presence of missing value
df3 <- df2 %>%
  dplyr::select(ps_var2)
qualify_var3 <- sapply(df3, function(i){sum(is.na(i))/length(i) > 0})
var_to_impute <-  names(df3)[qualify_var3]

# show missing proportions
sapply(df3, function(i){sum(is.na(i))/length(i)})
```

This is a visualization of missing value patterns. Overall, the missing pattern seems reasonable with little suggestion of strong dependence patterns in the data.
```{r visualize_missing, echo=F, fig.width=12}
# visual missing pattern
df3 %>%
  dplyr::select(var_to_impute) %>%
  aggr()
```

### Missing Value Imputation         
This is the step of imputation. I have classified the variables with missing values into five categories based on my best judgment and the codebook (which contains the values of coding a given variable). Specifically, missing values were imputed as (a) zero, (b) one, (c) median of the variable, (d) 'other' category of the corresponding variable, and (e) values from checking the original publications.
```{r impute_missing_value, echo=T}
var_to_impute_zero <- c("TARGETED", "RACETARG", "GENDTARG", "CULTURE", "SAMEDIFF", "SELFSEL",  "intyn", "RPRTBHVR", "FCLBHVR", "DTCONT", "rprt", "SUBJGRP", "GR1", "GR2", "GR3")
var_to_impute_one <- c("FLUP")
# var_to_impute_median <- c("rcptmsi")    # median = 50 (percentage value)        # 1st submission
# median(df3$RCPTFsi, na.rm =T)
var_to_impute_median <- c("RCPTFsi")    # median = 51 (percentage value)          # 1st revision
var_to_impute_other <- c("WHOTARGT",    # other - 25 (value from codebook)
                         "RECRUIT",     # other - 30
                         "areaj",       # other - 6
                         "srctyp")      # other - 11
var_to_impute_from_paper <- c("pubyear", "langj", "countryj", "designj")


# deal with 'csrpeer' separately due to Ben's relabeling
df3 <- df3 %>%
  mutate(csrpeer = case_when(
    csrpeer == "Y" ~ 1,
    csrpeer == "N" ~ 0,
    TRUE ~ 0
  ))

# impute zero
df3 <- df3 %>%
  mutate(across(var_to_impute_zero, ~ replace_na(.x, 0)))

# impute one
df3 <- df3 %>%
  mutate(across(var_to_impute_one, ~ replace_na(.x, 1)))

# impute median
df3 <- df3 %>%
  mutate(across(var_to_impute_median, ~ replace_na(.x, median(.x, na.rm = T))))     # median = 50

# impute 'other' category (values from codebook)
df3 <- df3 %>%
  mutate(across("WHOTARGT", ~ replace_na(.x, 25)),
         across("RECRUIT", ~ replace_na(.x, 30)),
         across("areaj", ~ replace_na(.x, 6)),
         across("srctyp", ~ replace_na(.x, 11)))

# regenerate 'pubyear' from 'authyear'
df3 <- df3 %>%
  dplyr::select(-pubyear) %>%
  mutate(pubyear = str_extract(authyear, "\\d{4}")) #%>%
  # dplyr::select(-authyear)

# impute from papers
df_lang <- df3[which(is.na(df3$langj)), ]
df3$langj[which(is.na(df3$langj))] <- "English" 

df_country <- df3[which(is.na(df3$countryj)), ]
df3$countryj[which(df3$authyear == "Geliebter, A., 1997 (completed)")] <- "US"           # Geliebter et al. 1997
df3$countryj[which(df3$authyear == "Yonkers et al. 2012")] <- "US"                        # Yonkers et al. 2012
df3$countryj[which(df3$authyear == "Bahromov & Weine, 2011 (updated)")] <- "Tajikistan"   # Bahromov & Weine(2011)
# df3$countryj[which(df3$studyid == 87)] <- "Peru"         # Garda et al. (2012)

df_design <- df3[which(is.na(df3$designj)), ]
df3$designj[which(is.na(df3$designj))] <- 1              # RCTs 
```

Here we check that the data are without missing values after imputation.
```{r, echo=F}
sort(sapply(df3, function(i){sum(is.na(i))/length(i)}))
```

### Handling Unexpected Values in Variables        
In this step, we need to clean several variables regarding their coding. At the bottom of my R code, I listed several variables that showed unexpected coding values. For instance, the first of those variable is 'SAMEDIFF,' whose coding values are supposed to be either 1 (Yes) or 0 (No) according to the codebook. I also listed unexpected values (i.e., 2, 3, 4) in the same line of code. We need to make decisions in handling these values by perhaps recoding them into existing values in our codebook. Once we finalize the decisions and the dataset will be finalized. Could you share thoughts regarding how you think about the decisions made in previous steps and how you suggest to recode the values here? A few variables may be further dropped in this step due to extremely unbalanced values (e.g., showing 0 values on 667/669 cases). 
```{r var_class_category, echo=T}
df4 <- df3 %>%
  dplyr::select(-reference) 
var_factor <- c("studyid", "ID", "TARGETED", "WHOTARGT", "RACETARG", "GENDTARG", "CULTURE", "SAMEDIFF", "SELFSEL", "RECRUIT",
                "scaa", "scna", "scta", "scai", "scas", "scbar", "sctime", "scsm", "scmi", 
                "csrpeer", "intyn", "TWGR", "RPRTBHVR", "FLUP", "FCLBHVR", "DTCONT", "rprt", 
                "areaj", "srctyp", "langj", "countryj", "designj", 
                "SUBJGRP", "GR1", "GR2", "GR3")                                                      # 36 var
var_numeric <- c("NMainrecom", "nopostt", "NAUXrecomend", 
                 "RCPTFsi",  # "rcptmsi", 
                 "pubyear")                      # 5 var
var_NOT_tabyl <- c(var_numeric, "studyid", "ID", "authyear", "baseline")


## check variable dist. and drop below variables due to extremely uneven dist.
df4_tabyl <- df4 %>% dplyr::select(-var_NOT_tabyl)
sink(paste0(mac_desktop, "tables.txt")); lapply(df4_tabyl, tabyl); sink()

## decisions to clarify the variable categories after imputation --------------------------------- 
## variables w/ --- are those needing adjustment in next step    ---------------------------------

# --- TARGETED # 25 -> 0 (No)
# SAMEDIFF  #  2, 3, 4?
# --- SELFSEL # 2, 3, 9 -> 0 (No)
# RECRUIT  # 11, 39, 77?
# --- scna     # 9 -> 0 (No)
# --- scai   # 2 -> 0 (No)
# --- scas    # 9 -> 0 (No)
# --- scbar  # 9 -> 0 (No)
# sctime    # 9
# TWGR   # 2
# FCLBHVR # 2
# --- rprt     # 2 -> 0 (No)
# srctyp   # 0
# langj # drop? almost all english
# --- countryj # combine into continents
# --- designj   # 2, 4, 5, 6 -> 2 (non-experimental); 1, 3 -> 1 (experimental) 
# SUBJGRP  # 2

var_to_drop <- c("intyn", "TWGR", "DTCONT", "langj", "SUBJGRP",                          # < 10 cases on a dichotomous category 
                 "SAMEDIFF", "scta", "sctime", "scmi", "csrpeer", "FCLBHVR", "srctyp",   # < 15% available cases on a dichotomous category
                 "WHOTARGT", "RECRUIT", "areaj")                                         # variable w/ several categories that make PSM evaluation difficult
```



```{r adjust_transform_var, echo=F, fig.width=12}
df5 <- df4 %>% dplyr::select(-var_to_drop)

## adjust the variables
df5 <- df5 %>% 
  mutate(across(any_of(var_factor), as.character)) %>%
  mutate(across(any_of(var_numeric), as.numeric)) %>%
  mutate(rcptmsi = 100 - RCPTFsi) %>%
  mutate(
    # adjust treatment variable
    NMainrecom_ord = case_when(                                        
      NMainrecom >= 4 ~ 4,            # may also think about doing >= 3, resulting in almost even dist.
      TRUE ~ NMainrecom),
    
    # adjust discrete covariates
    countryj = case_when(                                              # clean categories                               
      countryj %in% c("America", 
                      "Canada, UK, USA", 
                      "U.S.",
                      "U.S",
                      "United States",
                      "United States of America",
                      "US",
                      "usa",
                      "NY",
                      "USA") ~ "US",
      countryj %in% c("china", 
                      "China", 
                      "Chine",
                      "Taiwan") ~ "China",
      countryj %in% c("England", 
                      "UK", 
                      "United Kingdom") ~ "UK",
      countryj %in% c("India", 
                      "Indian") ~ "India",
      countryj %in% c("Iran", 
                      "IRAN",
                      "Islamic Republic of Iran") ~ "Iran",
      countryj %in% c("japan", 
                      "Japan") ~ "Japan",
      countryj %in% c("The Nederlands", 
                      "Amsterdam Netherlands",
                      "The Netherlands") ~ "Netherlands",
      TRUE ~ countryj), 
    
    countryj2 = case_when(                                            # combine less popoular categories into 'other'
      countryj %in% c("Chile",
                      "Denmark",
                      "Madagascar",
                      "Malaysia",
                      "New Zealand",
                      "Peru",
                      "Russia",
                      "Saudi Arabia",
                      "Sto Domingo",
                      "Switzerland",
                      "Tajikistan",
                      "Tanzania",
                      "Vietnam",
                      "Zimbabwe",
                      "The Netherlands") ~ "Others(one_trial)",
      TRUE ~ countryj),
    
    continentj = case_when(                                          # further collapse countries into continents
      countryj %in% c("Australia",                 # can also be added to 'Asia"
                      "New Zealand",               # can also be added to 'Asia"
                      "Belgium",
                      "Finland",
                      "France",
                      "Germany",
                      "Italy",
                      "Netherlands",
                      "Norway",
                      "Spain",
                      "Sweden",
                      "Turkey",
                      "UK",
                      "Denmark",
                      "Russia",
                      "Switzerland",
                      "The Netherlands") ~ "Europe_AusNew",
      countryj %in% c("US",
                      "Canada") ~ "North_America",
      countryj %in% c("Brazil", 
                      "Chile",
                      "Peru",
                      "Sto Domingo") ~ "South_America",
      countryj %in% c("China", 
                      "India",
                      "Iran",
                      "Japan",
                      "Korea",
                      "Taiwan",
                      "Thailand",
                      "Malaysia",
                      "Saudi Arabia",
                      "Tajikistan",
                      "Vietnam") ~ "Asia",
      countryj %in% c("Kenya", 
                      "South Africa",
                      "Uganda",
                      "Madagascar",
                      "Tanzania",
                      "Zimbabwe") ~ "Africa",
      TRUE ~ countryj),
    
    regionj = case_when(                                         # for Batch 2 models in building PSM
      continentj != "North_America" ~ "Other_region", 
      TRUE ~ continentj
    ),
    
    TARGETED = case_when(
      TARGETED %in% c("25") ~ "0",
      TRUE ~ TARGETED
    ),
    
    SELFSEL = case_when(
      SELFSEL %in% c("2", "3", "9") ~ "0",
      TRUE ~ SELFSEL
    ),
    
    scna = case_when(
      scna %in% c("9") ~ "0",
      TRUE ~ scna
    ),
    
    scai = case_when(
      scai %in% c("2") ~ "0",
      TRUE ~ scai
    ),
    
    scas = case_when(
      scas %in% c("9") ~ "0",
      TRUE ~ scas
    ),
    
    scbar = case_when(
      scbar %in% c("9") ~ "0",
      scbar %in% c("2") ~ "1",
      TRUE ~ scbar
    ),
    
    rprt = case_when(
      rprt %in% c("2") ~ "0",
      TRUE ~ rprt
    ),
    
    designj = case_when(
      designj %in% c("2", "4", "5", "6") ~ "0",     # 0 : non-experimental
      TRUE ~ "1"                                    # 1 : experimental
    ),
    
    # adjust continuous covariates into ordinal ones
    pubyear_ord = case_when(                                    # based on Nigg02 & Ory02: The Behavior Change Consortium
      pubyear < 2003 ~ 0, 
      pubyear >= 2003 & pubyear < 2010 ~ 1,
      pubyear >= 2010 ~ 2
    ),
    
    rcptmsi_ord = case_when(
      rcptmsi < 25 ~ 0, 
      rcptmsi >= 25 & rcptmsi < 50 ~ 1,
      rcptmsi >= 50 & rcptmsi < 75 ~ 2,
      rcptmsi >= 75 ~ 3
    ),
    
    nopostt_ord = case_when(                                    # adjusted for Batch 2 models in building PSM
      nopostt >= 2 ~ 2,                                         # change 3 into 2 so the variable is ditchotomous
      TRUE ~ nopostt
    ),
     
    NAUXrecomend_ord = case_when(
      NAUXrecomend >= 3 ~ 3, 
      TRUE ~ NAUXrecomend
    )
      ) %>%
  mutate(across(any_of(var_factor), as.factor))

# check the new variables
df5_tabyl <- df5 %>% dplyr::select(-var_NOT_tabyl)
sink(paste0(mac_desktop, "tables_adj.txt")); lapply(df5_tabyl, tabyl); sink()

# reorder the variables
df5 <- df5 %>%
  relocate(where(is.numeric), .before = where(is.factor)) %>%           
  relocate(NMainrecom, NMainrecom_ord) %>%
  relocate(countryj, .after = GR3) %>%
  mutate(across(c(countryj2, continentj, regionj,
                  NMainrecom_ord, pubyear_ord, rcptmsi_ord, nopostt_ord, NAUXrecomend_ord), as.factor))

# write_csv(df5, paste0(win, "Zone/PSM_data2.csv"))      # 1st submission
write_csv(df5, paste0(mac2, "PSM_data2_new.csv"))        # 1st revision
```


```{r visualize_var, echo=F, fig.width=12}
# visualize the distribution of variables
ggpairs(df5[c("NMainrecom", "NMainrecom_ord", "nopostt", "NAUXrecomend", "rcptmsi", "pubyear")], lower = list(continuous=wrap("points", position=position_jitter(), size=0.5)))

ggpairs(df5[c("NMainrecom", "NMainrecom_ord", "nopostt_ord", "NAUXrecomend_ord", "rcptmsi_ord", "pubyear_ord")], lower = list(continuous=wrap("points", position=position_jitter(), size=0.5)))

df5 %>% select(any_of(var_factor[3:15])) %>% ggpairs(cardinality_threshold = NULL, lower = list(continuous=wrap("points", position=position_jitter(), size=0.5)))

df5 %>% select(any_of(var_factor[16:29])) %>% ggpairs(cardinality_threshold = NULL, lower = list(continuous=wrap("points", position=position_jitter(), size=0.5)))

df5 %>% select(any_of(var_factor[30:length(var_factor)])) %>% ggpairs(cardinality_threshold = NULL, lower = list(continuous=wrap("points", position=position_jitter(), size=0.5)))
```








